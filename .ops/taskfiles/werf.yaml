version: '3'

vars:
  ENVIRONMENT: '{{default .CLI_ARGS .ENVIRONMENT}}'

tasks:
# Tasks: Werf commands
  command:
    cmds:
      - werf {{.COMMAND}}
        --env {{.ENVIRONMENT}}
    requires:
      vars: [ENVIRONMENT, COMMAND]

  command-with-repo:
    cmds:
      - werf {{.COMMAND}}
        --env {{.ENVIRONMENT}}
        --release {{.ENVIRONMENT}}
        --repo {{.ACR_URL}}/{{.ENVIRONMENT}}/{{.PROJECT}}
    requires:
      vars: [ENVIRONMENT, PROJECT, COMMAND]

  build:
    cmds:
      - werf build --repo {{.ACR_URL}}/{{.ENVIRONMENT}}/{{.PROJECT}}
    requires:
      vars: [ACR_URL, ENVIRONMENT, PROJECT]

  dismiss:
    cmds:
      - werf dismiss
        --namespace {{.PROJECT}}-{{.ENVIRONMENT}}
        --release {{.PROJECT}}-{{.ENVIRONMENT}}
    requires:
      vars: [ENVIRONMENT, PROJECT]

  export:
    cmds:
      - werf export
        --repo {{.ACR_URL}}/{{.ENVIRONMENT}}/{{.PROJECT}}
        --tag {{.ACR_URL}}/{{.ENVIRONMENT}}/{{.PROJECT}}:{{.ENVIRONMENT}}
    requires:
      vars: [ACR_URL, ENVIRONMENT, PROJECT]
